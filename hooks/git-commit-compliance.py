#!/usr/bin/env python3
"""
Git Commit Compliance Hook

Enforces commit standards:
- Required: -S (GPG sign) and -s (signoff) flags
- Forbidden: Claude attribution in commit messages
- Required: Meaningful commit message (â‰¥10 chars)

Hard blocks non-compliant commits.
"""
from __future__ import annotations  # Python 3.9 compatibility (PEP 563)

import json
import re
import sys
from typing import Optional


# Forbidden patterns in commit messages
FORBIDDEN_PATTERNS = [
    r'co-authored-by:\s*claude',
    r'generated.*claude',
    r'claude.*generated',
    r'ðŸ¤–.*claude',
    r'claude\s*code',
]


def is_git_command(command: str) -> bool:
    """Check if this is a git command we should validate.

    Returns True for:
    - Direct git commands: git status, git add, etc.
    - Shell-wrapped: bash -c "git ...", /bin/zsh -c 'git ...'
    - With sudo: sudo git push

    Returns False for:
    - Commands that merely mention git in text: gh issue create --body "git workflow"
    - Non-git commands
    """
    # Direct git command (optionally with sudo)
    if re.match(r'^\s*(?:sudo\s+)?git\s+', command):
        return True
    # Shell-wrapped git command (bash/sh/zsh -c "git ..." or 'git ...')
    if re.match(r'^\s*(?:sudo\s+)?(?:/[\w/]*)?(?:ba|z)?sh\s+-c\s+["\'](?:sudo\s+)?git\s+', command):
        return True
    return False


def is_commit_command(command: str) -> bool:
    """Check if this is a git commit command."""
    if not is_git_command(command):
        return False
    # Look for 'git commit' pattern (not in quoted strings for other commands)
    return bool(re.search(r'git\s+commit(?:\s|$)', command))


def check_required_flags(command: str) -> Optional[str]:
    """Check for required -S and -s flags."""
    missing = []

    # Check for -S (GPG sign) - can be -S or --gpg-sign
    if not re.search(r'\s-S(?:\s|$)|\s--gpg-sign', command):
        missing.append("-S (GPG signing)")

    # Check for -s (signoff) - can be -s or --signoff
    if not re.search(r'\s-s(?:\s|$)|\s--signoff', command):
        missing.append("-s (signoff)")

    if missing:
        return (
            f"âŒ Missing required flags: {', '.join(missing)}\n\n"
            "Required commit format:\n"
            "  git commit -S -s -m \"message\"\n\n"
            "Flags:\n"
            "  -S  GPG sign the commit\n"
            "  -s  Add Signed-off-by line"
        )
    return None


def check_forbidden_attribution(command: str) -> Optional[str]:
    """Check for forbidden Claude attribution in commit message."""
    # Extract commit message from -m flag
    message_match = re.search(r'-m\s+["\'](.+?)["\']', command, re.DOTALL)
    if not message_match:
        # Also check for heredoc style
        message_match = re.search(r'-m\s+"\$\(cat\s+<<[\'"]?EOF[\'"]?\n(.+?)\nEOF', command, re.DOTALL)

    if message_match:
        message = message_match.group(1).lower()
        for pattern in FORBIDDEN_PATTERNS:
            if re.search(pattern, message, re.IGNORECASE):
                return (
                    "âŒ Commit message contains forbidden Claude attribution\n\n"
                    "Do not include:\n"
                    "  - Co-Authored-By: Claude\n"
                    "  - 'Generated by Claude'\n"
                    "  - Claude Code references\n"
                    "  - ðŸ¤– emoji with Claude\n\n"
                    "User takes full responsibility for all commits."
                )
    return None


def check_message_quality(command: str) -> Optional[str]:
    """Check that commit message is meaningful."""
    # Extract commit message
    message_match = re.search(r'-m\s+["\'](.+?)["\']', command)
    if not message_match:
        message_match = re.search(r'-m\s+"\$\(cat\s+<<[\'"]?EOF[\'"]?\n(.+?)\nEOF', command, re.DOTALL)

    if message_match:
        message = message_match.group(1).strip()
        # Get first line for length check
        first_line = message.split('\n')[0].strip()
        if len(first_line) < 10:
            return (
                f"âŒ Commit message too short ({len(first_line)} chars)\n\n"
                "Commit messages should:\n"
                "  - Be at least 10 characters\n"
                "  - Describe what changed and why\n"
                "  - Use imperative mood (\"Add feature\" not \"Added feature\")"
            )
    return None


def main():
    # Read hook input from stdin
    try:
        hook_input = json.load(sys.stdin)
    except json.JSONDecodeError:
        print(json.dumps({"proceed": True}))
        return

    tool_name = hook_input.get("tool_name", "")
    tool_input = hook_input.get("tool_input", {})

    # Only check Bash tool
    if tool_name != "Bash":
        print(json.dumps({"proceed": True}))
        return

    command = tool_input.get("command", "")

    # Only check git commit commands
    if not is_commit_command(command):
        print(json.dumps({"proceed": True}))
        return

    # Run all checks
    checks = [
        check_required_flags,
        check_forbidden_attribution,
        check_message_quality,
    ]

    for check in checks:
        error = check(command)
        if error:
            print(json.dumps({
                "proceed": False,
                "reason": error
            }))
            return

    # All checks passed
    print(json.dumps({"proceed": True}))


if __name__ == "__main__":
    main()
